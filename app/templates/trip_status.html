{% extends "base.html" %}

{% block content %}
<div id="trip-dashboard-content" class="bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto">

    <h1 class="text-2xl font-bold mb-2">Trip Status: {{ trip.name }}</h1>
    <p class="text-gray-600 mb-6">Here's the current progress of your trip planning.</p>

    <div id="recommendations-section">
        {% if trip.recommendations %}
            <h2 class="text-xl font-semibold mb-4">Time to Vote!</h2>
            <p class="mb-4">Our AI has generated the following recommendations. Please have each participant vote using their unique link.</p>

            <div class="space-y-6 my-6">
            {% for rec in trip.recommendations %}
                <div class="border rounded-lg p-4">
                    <h4 class="text-lg font-bold">{{ rec.destination_name }}</h4>
                    <p class="text-gray-700 italic">"{{ rec.reason }}"</p>
                    <p class="font-semibold mt-2">Budget: {{ rec.estimated_budget }}</p>

                    <div class="mt-4">
                        <h5 class="font-semibold">Personalized Travel Info:</h5>
                        {% for contact, details in rec.details.travel_info.items() %}
                        <div class="ml-4 mt-2 border-l-2 pl-2">
                            <p><strong>{{ contact }}:</strong></p>
                            <p class="text-sm">üöó {{ details.route }}</p>
                            <p class="text-sm">‚úàÔ∏è Flights:
                                {% for flight in details.flights %}
                                    {{ flight.airline }} (~{{ flight.price }})
                                {% endfor %}
                            </p>
                            {% if details.map_url %}
                            <iframe
                              width="100%"
                              height="250"
                              style="border:0; margin-top: 8px; border-radius: 8px;"
                              loading="lazy"
                              allowfullscreen
                              src="{{ details.map_url }}">
                            </iframe>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
            </div>
            <h3 class="font-semibold">Voting Status:</h3>
            <ul class="list-inside list-disc">
            {% for p in trip.participants %}
                <li>
                    {{ p.contact_info }}:
                    {% if p.id in voted_participant_ids %}
                        <span class="text-green-500 font-bold ml-2">‚úÖ Voted!</span>
                    {% else %}
                        <a href="/trip/{{ trip.id }}/vote/{{ p.id }}" class="text-blue-500 hover:underline ml-2">Vote Here</a>
                    {% endif %}
                </li>
            {% endfor %}
            </ul>

        {% else %}
            <h2 class="text-xl font-semibold mb-4">Next Step: Generate Recommendations</h2>
            <p class="mb-4">Once all participants have filled out their surveys, click the button below to get personalized recommendations from our AI.</p>

            <button
                hx-post="/trips/{{ trip.id }}/generate-recommendations"
                hx-target="#recommendations-section"
                hx-swap="innerHTML"
                class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
            >
                ‚ú® Generate AI Recommendations
            </button>
        {% endif %}
    </div>

    {% if vote_count == trip.participants|length and trip.recommendations %}
        <div class="mt-8 text-center border-t pt-6">
            <h2 class="text-xl font-semibold mb-4">Voting is complete!</h2>
            <button
                hx-get="/trip/{{ trip.id }}/results"
                hx-target="#trip-dashboard-content"
                hx-swap="innerHTML"
                class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg"
            >
                üèÜ See the Winning Destination!
            </button>
        </div>
    {% endif %}
    <div class="mt-8 text-center">
        <a href="/" class="text-gray-500 hover:underline">‚Üê Back to Home</a>
    </div>

</div>
{% endblock %}